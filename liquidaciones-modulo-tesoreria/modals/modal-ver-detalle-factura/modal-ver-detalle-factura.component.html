<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" (click)="onCerrar()">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[95vh] overflow-hidden"
        (click)="$event.stopPropagation()">

        <!-- Header ultra compacto -->
        <div
            class="bg-gradient-to-r from-blue-600 to-purple-600 px-5 py-3 flex items-center justify-between text-white">
            <div class="flex items-center gap-2">
                <lucide-icon [img]="icons.FileText" class="w-6 h-6"></lucide-icon>
                <h2 class="text-lg font-semibold">Detalle de Factura</h2>
            </div>
            <button (click)="onCerrar()" class="hover:bg-white/20 rounded p-1.5 transition">
                <lucide-icon [img]="icons.X" class="w-5 h-5"></lucide-icon>
            </button>
        </div>

        <!-- Contenido compacto y eficiente -->
        <div class="overflow-y-auto max-h-[calc(95vh-130px)] p-4 space-y-4 text-sm">

            <!-- Info básica de factura (lo más compacto posible) -->
            <div class="bg-gray-50 rounded-lg p-4">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-3">
                    <div>
                        <span class="text-gray-600 text-xs">Factura</span>
                        <p class="font-mono font-bold text-lg">{{ factura.numero_factura }}</p>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs">Emisor</span>
                        <p class="font-medium truncate">{{ factura.nombre_emisor }}</p>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs">Fecha</span>
                        <p>{{ FormatHelper.formatFecha(factura.fecha_emision) }}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-gray-600 text-xs">Total</span>
                        <p class="text-xl font-bold text-gray-900">{{
                            FormatHelper.formatMonto(factura.monto_total_factura) }}</p>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs">Estado</span>
                        <span class="block mt-1 px-2 py-1 rounded text-xs font-medium bg-green-100 text-green-800">
                            {{ factura.estado_liquidacion }}
                        </span>
                    </div>
                    <div>
                        <span class="text-gray-600 text-xs">Tipo</span>
                        <span class="block mt-1 px-2 py-1 rounded text-xs font-medium"
                            [class]="FormatHelper.getColorTipo(factura.tipo_liquidacion).bg + ' ' + FormatHelper.getColorTipo(factura.tipo_liquidacion).text">
                            {{ FormatHelper.getEtiquetaTipo(factura.tipo_liquidacion) }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Transferencias (compactas) -->
            <div *ngIf="tieneTransferencias(); else sinTransferencias" class="space-y-3">
                <h3 class="font-medium text-blue-900 flex items-center gap-2">
                    <lucide-icon [img]="icons.DollarSign" class="w-5 h-5"></lucide-icon>
                    Transferencias ({{ factura.transferencias.length }})
                </h3>
                <div *ngFor="let t of factura.transferencias; let i = index" class="bg-blue-50 rounded p-3 text-xs">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-blue-700">#{{ i + 1 }}</span>
                        <span class="font-bold text-blue-900">{{ FormatHelper.formatMonto(t.monto) }}</span>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-gray-700">
                        <div class="truncate"><strong>{{ t.nombre_cuenta }}</strong></div>
                        <div class="text-right">{{ t.nombre_banco }}</div>
                        <div class="font-mono col-span-2">{{ t.numero_cuenta }} • {{ t.tipo_cuenta }}</div>
                        <div *ngIf="t.correo_proveedor" class="col-span-2 text-gray-600 truncate">{{ t.correo_proveedor
                            }}</div>
                    </div>
                </div>
                <div class="bg-blue-100 rounded p-3 font-medium text-blue-900 flex justify-between">
                    <span>Total Transferencias</span>
                    <span>{{ FormatHelper.formatMonto(factura.monto_total_transferencias) }}</span>
                </div>
            </div>
            <ng-template #sinTransferencias>
                <p class="text-center text-gray-500 py-3 text-xs">Sin transferencias programadas</p>
            </ng-template>

            <!-- Retenciones (super compactas) -->
            <div *ngIf="tieneRetenciones(); else sinRetenciones" class="space-y-2">
                <h3 class="font-medium text-orange-900 flex items-center gap-2">
                    <lucide-icon [img]="icons.MinusCircle" class="w-5 h-5"></lucide-icon>
                    Retenciones
                </h3>
                <div *ngFor="let r of factura.retenciones"
                    class="bg-orange-50 rounded p-2 text-xs flex justify-between">
                    <div>
                        <span class="font-medium">{{ r.nombre }}</span>
                        <span *ngIf="r.descripcion" class="text-gray-600 ml-2">{{ r.descripcion }}</span>
                    </div>
                    <span class="font-bold text-orange-900">-{{ FormatHelper.formatMonto(r.monto) }}</span>
                </div>
                <div class="bg-orange-100 rounded p-3 font-medium text-orange-900 flex justify-between">
                    <span>Total Retenciones</span>
                    <span>-{{ FormatHelper.formatMonto(factura.monto_total_retenciones) }}</span>
                </div>
            </div>
            <ng-template #sinRetenciones>
                <p class="text-center text-gray-500 py-3 text-xs">Sin retenciones</p>
            </ng-template>

            <!-- Monto pendiente (dest bien visible) -->
            <div class="bg-emerald-50 rounded-lg p-4 border-l-4 border-emerald-500">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-medium text-emerald-900">Monto Pendiente de Pago</p>
                        <p class="text-xs text-emerald-700">Después de todo</p>
                    </div>
                    <p class="text-2xl font-bold text-emerald-900">
                        {{ FormatHelper.formatMonto(factura.monto_pendiente_pago) }}
                    </p>
                </div>
            </div>

            <!-- Solicitud (si existe) -->
            <div *ngIf="tieneSolicitud()" class="bg-purple-50 rounded-lg p-4 text-xs border-l-4 border-purple-500">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="font-medium text-purple-900 flex items-center gap-2">
                        <lucide-icon [img]="icons.CheckCircle2" class="w-5 h-5"></lucide-icon>
                        Solicitud: {{ factura.solicitud!.codigo_solicitud }}
                    </h3>
                    <span class="px-2 py-1 rounded text-xs font-bold"
                        [class]="FormatHelper.getColorEstadoSolicitud(factura.solicitud!.estado).bg + ' ' + FormatHelper.getColorEstadoSolicitud(factura.solicitud!.estado).text">
                        {{ FormatHelper.getEtiquetaEstadoSolicitud(factura.solicitud!.estado) }}
                    </span>
                </div>
                <div class="grid grid-cols-2 gap-2 text-gray-700">
                    <div><strong>Monto:</strong> {{ FormatHelper.formatMonto(factura.solicitud!.monto_total_solicitud)
                        }}</div>
                    <div><strong>Banco:</strong> {{ factura.solicitud!.banco_nombre }}</div>
                    <div class="col-span-2"><strong>Área:</strong> {{
                        FormatHelper.getEtiquetaArea(factura.solicitud!.area_aprobacion) }}</div>
                </div>
                <div *ngIf="factura.solicitud!.estado === 'completado'"
                    class="mt-3 pt-3 border-t border-purple-200 text-xs">
                    <p class="font-medium text-purple-900 mb-1">Comprobante registrado:</p>
                    <span class="font-mono">{{ factura.solicitud!.numero_registro_transferencia }}</span>
                    <span class="text-gray-600 ml-2">
                        {{ FormatHelper.formatFecha(factura.solicitud!.fecha_transferencia) }}
                    </span>
                </div>
            </div>

            <!-- Sin solicitud -->
            <div *ngIf="!tieneSolicitud()" class="bg-yellow-50 rounded-lg p-3 border-l-4 border-yellow-500 text-xs">
                <div class="flex items-center gap-2">
                    <lucide-icon [img]="icons.AlertCircle" class="w-5 h-5 text-yellow-600"></lucide-icon>
                    <span class="font-medium text-yellow-900">Esta factura no tiene solicitud de pago</span>
                </div>
            </div>

        </div>

        <!-- Footer minimalista -->
        <div class="bg-gray-50 px-5 py-3 border-t flex justify-end">
            <button (click)="onCerrar()"
                class="px-6 py-2 text-sm font-medium text-white bg-gradient-to-r from-blue-600 to-purple-600 rounded hover:from-blue-700 hover:to-purple-700 transition">
                Cerrar
            </button>
        </div>
    </div>
</div>