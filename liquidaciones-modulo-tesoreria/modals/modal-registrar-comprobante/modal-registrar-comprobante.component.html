<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" (click)="onCerrar()">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[95vh] overflow-hidden"
        (click)="$event.stopPropagation()">

        <!-- Header compacto -->
        <div [class]="colorHeader()" class="px-5 py-3.5 flex items-center justify-between text-white">
            <div class="flex items-center gap-2.5">
                <lucide-icon [img]="icons.CheckCircle" class="w-6 h-6"></lucide-icon>
                <h2 class="text-lg font-semibold">{{ titulo() }}</h2>
            </div>
            <button (click)="onCerrar()" [disabled]="procesando()" class="hover:bg-white/20 rounded p-1.5 transition">
                <lucide-icon [img]="icons.X" class="w-5 h-5"></lucide-icon>
            </button>
        </div>

        <!-- Contenido ultra compacto -->
        <div class="overflow-y-auto max-h-[calc(95vh-140px)] p-5 space-y-4">

            <!-- Info solicitud (compacta) -->
            <div *ngIf="solicitud" class="bg-gray-50 rounded-lg p-4 text-sm">
                <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                    <div><span class="text-gray-600">Código:</span> <strong class="font-mono">{{
                            solicitud.codigo_solicitud }}</strong></div>
                    <div class="text-right">
                        <span class="text-gray-600">Monto:</span><br>
                        <span class="text-lg font-bold text-green-600">{{
                            FormatHelper.formatMonto(solicitud.monto_total_solicitud) }}</span>
                    </div>
                    <div><span class="text-gray-600">Banco:</span> {{ solicitud.banco_nombre }}</div>
                    <div><span class="text-gray-600">Área:</span> {{
                        FormatHelper.getEtiquetaArea(solicitud.area_aprobacion) }}</div>
                </div>
            </div>

            <!-- Comprobante actual (solo edición) -->
            <div *ngIf="modoEdicion && solicitud"
                class="bg-orange-50 rounded-lg p-3 text-xs border-l-4 border-orange-400">
                <div class="grid grid-cols-2 gap-2">
                    <div><strong>Actual:</strong> {{ solicitud.numero_registro_transferencia || '—' }}</div>
                    <div class="text-right">{{ FormatHelper.formatFecha(solicitud.fecha_transferencia) }}</div>
                    <div class="col-span-2 text-gray-700 italic">{{ solicitud.referencia_bancaria || 'Sin referencia' }}
                    </div>
                </div>
            </div>

            <!-- Formulario minimalista -->
            <form [formGroup]="form" class="space-y-4">

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">N° de Registro *</label>
                    <input type="text" formControlName="numero_registro_transferencia" placeholder="REG-2025-0123"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Fecha de Transferencia *</label>
                    <input type="date" formControlName="fecha_transferencia"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Referencia Bancaria</label>
                    <input type="text" formControlName="referencia_bancaria" placeholder="Opcional"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Observaciones</label>
                    <textarea formControlName="observaciones" rows="2" placeholder="Opcional..."
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 resize-none"></textarea>
                </div>

                <!-- Archivo minimalista -->
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Comprobante (opcional)</label>

                    <!-- Sin archivo -->
                    <div *ngIf="!tieneArchivo()"
                        class="border border-dashed border-gray-300 rounded-md p-4 text-center text-xs">
                        <lucide-icon [img]="icons.Upload" class="w-10 h-10 text-gray-400 mx-auto mb-2"></lucide-icon>
                        <label for="archivo-comprobante"
                            class="cursor-pointer text-blue-600 hover:text-blue-700 underline">
                            Seleccionar archivo
                        </label>
                        <input type="file" id="archivo-comprobante" class="hidden" accept="application/pdf,image/*"
                            (change)="onArchivoSeleccionado($event)">
                        <p class="text-gray-500 mt-1">PDF o imagen • máx 10 MB</p>
                    </div>

                    <!-- Con archivo -->
                    <div *ngIf="tieneArchivo()"
                        class="bg-green-50 border border-green-300 rounded-md p-3 flex items-center justify-between text-xs">
                        <div class="flex items-center gap-2">
                            <lucide-icon [img]="icons.FileText" class="w-5 h-5 text-green-600"></lucide-icon>
                            <div>
                                <p class="font-medium truncate max-w-48">{{ archivoSeleccionado()!.name }}</p>
                                <p class="text-gray-600">{{ FormatHelper.formatTamano(archivoSeleccionado()!.size) }}
                                </p>
                            </div>
                        </div>
                        <button type="button" (click)="removerArchivo()"
                            class="text-red-600 hover:bg-red-100 rounded p-1">
                            <lucide-icon [img]="icons.X" class="w-4 h-4"></lucide-icon>
                        </button>
                    </div>
                </div>

                <!-- Alerta mínima -->
                <div class="flex items-start gap-2 text-xs rounded p-3 border-l-4" [class.bg-yellow-50]="modoEdicion"
                    [class.bg-emerald-50]="!modoEdicion" [class.border-yellow-500]="modoEdicion"
                    [class.border-emerald-500]="!modoEdicion">
                    <lucide-icon [img]="icons.AlertCircle" [class.text-yellow-600]="modoEdicion"
                        [class.text-emerald-600]="!modoEdicion" class="w-4 h-4 mt-0.5 flex-shrink-0"></lucide-icon>
                    <div [class.text-yellow-800]="modoEdicion" [class.text-emerald-800]="!modoEdicion">
                        <strong>{{ modoEdicion ? 'Al guardar:' : 'Al registrar:' }}</strong>
                        {{ modoEdicion ? 'se actualizará el comprobante' : 'la solicitud se marcará como COMPLETADA' }}
                        <span *ngIf="!modoEdicion" class="block font-medium text-red-600 mt-1">Acción
                            irreversible</span>
                    </div>
                </div>

            </form>
        </div>

        <!-- Footer compacto -->
        <div class="bg-gray-50 px-5 py-3.5 border-t flex justify-end gap-3">
            <button (click)="onCerrar()" [disabled]="procesando()"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded hover:bg-gray-300 transition">
                Cancelar
            </button>
            <button (click)="onRegistrarComprobante()" [disabled]="form.invalid || procesando()" [class]="colorBoton()"
                class="inline-flex items-center gap-2 px-5 py-2 text-sm font-medium text-white rounded transition disabled:opacity-50">
                <lucide-icon [img]="icons.CheckCircle" class="w-4 h-4"></lucide-icon>
                <span *ngIf="!procesando()">{{ tituloBoton() }}</span>
                <span *ngIf="procesando()">Procesando...</span>
            </button>
        </div>
    </div>
</div>