<div class="fixed inset-0 z-50 flex items-center justify-center bg-black/40" (click)="onCerrar()">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg max-h-[95vh] overflow-hidden"
        (click)="$event.stopPropagation()">

        <!-- Header limpio -->
        <div [class]="colorHeader()" class="px-5 py-3.5 flex items-center justify-between text-white">
            <div class="flex items-center gap-2.5">
                <lucide-icon [img]="esEdicion() ? icons.Edit3 : icons.Send" class="w-6 h-6"></lucide-icon>
                <h2 class="text-lg font-semibold">{{ titulo() }}</h2>
            </div>
            <button (click)="onCerrar()" [disabled]="procesando()" class="hover:bg-white/20 rounded p-1.5 transition">
                <lucide-icon [img]="icons.X" class="w-5 h-5"></lucide-icon>
            </button>
        </div>

        <!-- Contenido compacto -->
        <div class="overflow-y-auto max-h-[calc(95vh-140px)] p-5 space-y-4">

            <!-- Info factura (más compacta) -->
            <div class="bg-gray-50 rounded-lg p-4 text-sm">
                <div class="grid grid-cols-2 gap-x-4 gap-y-2">
                    <div><span class="text-gray-600">Factura:</span> <strong>{{ factura.numero_factura }}</strong></div>
                    <div><span class="text-gray-600">Emisor:</span> {{ factura.nombre_emisor }}</div>
                    <div><span class="text-gray-600">Fecha:</span> {{ FormatHelper.formatFecha(factura.fecha_emision) }}
                    </div>
                    <div class="text-right">
                        <span class="text-gray-600">Pendiente:</span><br>
                        <span class="text-lg font-bold text-green-600">{{
                            FormatHelper.formatMonto(factura.monto_pendiente_pago) }}</span>
                    </div>
                </div>
            </div>

            <!-- Formulario ultra limpio -->
            <form [formGroup]="form" (ngSubmit)="submit()" class="space-y-4">

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Banco origen *</label>
                    <select formControlName="banco_origen_id"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar banco</option>
                        <option *ngFor="let b of bancos()" [value]="b.id">
                            {{ b.nombre }} - {{ b.cuenta }}
                        </option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Área de aprobación *</label>
                    <select formControlName="area_aprobacion"
                        class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar área</option>
                        <option *ngFor="let a of OPCIONES_AREA_APROBACION" [value]="a.value">{{ a.label }}</option>
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Monto a solicitar *</label>
                    <div class="relative">
                        <input type="number" step="0.01" formControlName="monto_total_solicitud" placeholder="0.00"
                            class="w-full px-3 py-2 pr-20 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button type="button" *ngIf="!esEdicion()" (click)="establecerMontoMaximo()"
                            class="absolute right-2 top-1/2 -translate-y-1/2 px-2.5 py-1 text-xs font-medium text-blue-700 bg-blue-100 rounded hover:bg-blue-200 transition">
                            Máximo
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">
                        Disponible: {{ FormatHelper.formatMonto(montoMaximo()) }}
                    </p>
                </div>

                <!-- Alerta mínima -->
                <div
                    class="flex items-start gap-2 text-xs text-amber-800 bg-amber-50 rounded p-3 border-l-4 border-amber-500">
                    <lucide-icon [img]="icons.AlertCircle"
                        class="w-4 h-4 text-amber-600 mt-0.5 flex-shrink-0"></lucide-icon>
                    <div>
                        <strong>{{ esEdicion() ? 'Al editar:' : 'Al crear:' }}</strong>
                        {{ esEdicion() ? 'volverá a pendiente' : 'se enviará a aprobación' }}
                    </div>
                </div>

            </form>
        </div>

        <!-- Footer compacto -->
        <div class="bg-gray-50 px-5 py-3.5 border-t flex justify-end gap-3">
            <button (click)="onCerrar()" [disabled]="procesando()"
                class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded hover:bg-gray-300 transition">
                Cancelar
            </button>
            <button (click)="submit()" [disabled]="form.invalid || procesando()" [class]="colorBoton()"
                class="inline-flex items-center gap-2 px-5 py-2 text-sm font-medium text-white rounded transition disabled:opacity-50">
                <lucide-icon [img]="esEdicion() ? icons.Edit3 : icons.Send" class="w-4 h-4"></lucide-icon>
                {{ procesando() ? 'Procesando...' : (esEdicion() ? 'Guardar' : 'Crear') }}
            </button>
        </div>
    </div>
</div>