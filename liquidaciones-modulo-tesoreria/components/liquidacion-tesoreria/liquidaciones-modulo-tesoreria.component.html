<!-- ============================================================================ -->
<!-- LIQUIDACIONES-MODULO-TESORERÍA - TEMPLATE PRINCIPAL -->
<!-- ============================================================================ -->

<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 p-4">
    <div class="mx-auto max-w-[1800px]">

        <!-- ================================================================ -->
        <!-- HEADER CON ESTADÍSTICAS -->
        <!-- ================================================================ -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6 border border-gray-100">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">
                        Liquidaciones de Tesorería
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">Gestión integral de transferencias bancarias</p>
                </div>

                <!-- Acciones principales -->
                <div class="flex flex-wrap gap-2">
                    <button (click)="refrescarDatos()" [disabled]="cargando()"
                        class="inline-flex items-center gap-2 px-4 py-2.5 bg-white border-2 border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 disabled:opacity-50 text-sm font-medium transition-all">
                        <lucide-icon [img]="RefreshCw" [class.animate-spin]="cargando()" class="w-4 h-4"></lucide-icon>
                        <span *ngIf="!cargando()">Actualizar</span>
                        <span *ngIf="cargando()">Cargando...</span>
                    </button>
                </div>
            </div>

            <!-- Estadísticas en Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4">
                <!-- Pendientes -->
                <div class="bg-gradient-to-br from-yellow-50 to-yellow-100 rounded-lg p-4 border border-yellow-200">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-medium text-yellow-700">Pendientes</p>
                        <span class="bg-yellow-200 text-yellow-800 px-2 py-1 rounded-full text-xs font-bold">
                            {{estadisticas().totalPendientes}}
                        </span>
                    </div>
                    <p class="text-xl font-bold text-yellow-800">
                        {{formatMonto(estadisticas().montoPendientes)}}
                    </p>
                </div>

                <!-- En Aprobación -->
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4 border border-blue-200">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-medium text-blue-700">En Aprobación</p>
                        <span class="bg-blue-200 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">
                            {{estadisticas().totalEnAprobacion}}
                        </span>
                    </div>
                    <p class="text-xl font-bold text-blue-800">
                        {{formatMonto(estadisticas().montoEnAprobacion)}}
                    </p>
                </div>

                <!-- Aprobadas -->
                <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-lg p-4 border border-green-200">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-medium text-green-700">Aprobadas</p>
                        <span class="bg-green-200 text-green-800 px-2 py-1 rounded-full text-xs font-bold">
                            {{estadisticas().totalAprobadas}}
                        </span>
                    </div>
                    <p class="text-xl font-bold text-green-800">
                        {{formatMonto(estadisticas().montoAprobadas)}}
                    </p>
                </div>

                <!-- Completadas -->
                <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 rounded-lg p-4 border border-indigo-200">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-medium text-indigo-700">Completadas</p>
                        <span class="bg-indigo-200 text-indigo-800 px-2 py-1 rounded-full text-xs font-bold">
                            {{estadisticas().totalCompletadas}}
                        </span>
                    </div>
                    <p class="text-xl font-bold text-indigo-800">
                        {{formatMonto(estadisticas().montoCompletadas)}}
                    </p>
                </div>

                <!-- Total General -->
                <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg p-4 border border-purple-200">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-xs font-medium text-purple-700">Total</p>
                        <span class="bg-purple-200 text-purple-800 px-2 py-1 rounded-full text-xs font-bold">
                            {{estadisticas().total}}
                        </span>
                    </div>
                    <p class="text-xl font-bold text-purple-800">
                        {{formatMonto(estadisticas().montoTotal)}}
                    </p>
                </div>
            </div>

            <!-- Estadísticas por tipo -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                <!-- Plan Empresarial -->
                <div class="bg-purple-50 rounded-lg p-3 border border-purple-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-purple-700">Plan Empresarial</p>
                            <p class="text-lg font-bold text-purple-800">{{formatMonto(estadisticas().montoPlan)}}</p>
                        </div>
                        <span class="bg-purple-200 text-purple-800 px-3 py-1 rounded-full text-sm font-bold">
                            {{estadisticas().totalPlan}}
                        </span>
                    </div>
                </div>

                <!-- Presupuesto -->
                <div class="bg-cyan-50 rounded-lg p-3 border border-cyan-200">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-xs font-medium text-cyan-700">Presupuesto</p>
                            <p class="text-lg font-bold text-cyan-800">{{formatMonto(estadisticas().montoPresupuesto)}}</p>
                        </div>
                        <span class="bg-cyan-200 text-cyan-800 px-3 py-1 rounded-full text-sm font-bold">
                            {{estadisticas().totalPresupuesto}}
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================================================ -->
        <!-- FILTROS Y BÚSQUEDA -->
        <!-- ================================================================ -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 border border-gray-100">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Filtro por tipo -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <lucide-icon [img]="Filter" class="w-4 h-4 inline mr-1"></lucide-icon>
                        Tipo de Liquidación
                    </label>
                    <select 
                        [value]="tipoFiltro()" 
                        (change)="cambiarTipoFiltro($any($any($event.target).value === 'todos' ? 'todos' : $any($event.target).value))"
                        class="w-full px-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        <option *ngFor="let opcion of opcionesTipo" [value]="opcion.value">
                            {{opcion.label}}
                        </option>
                    </select>
                </div>

                <!-- Búsqueda -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        Buscar
                    </label>
                    <div class="relative">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </div>
                        <input 
                            type="text" 
                            placeholder="Buscar por factura, emisor o código..."
                            (input)="buscar($any($event.target).value)"
                            class="w-full pl-10 pr-4 py-2.5 border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>
                </div>
            </div>
        </div>

        <!-- ================================================================ -->
        <!-- PESTAÑAS CON CONTENIDO -->
        <!-- ================================================================ -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden border border-gray-100">
            
            <!-- Navegación de pestañas -->
            <div class="border-b border-gray-200 bg-gray-50">
                <nav class="flex flex-wrap -mb-px">
                    <!-- Pestaña: Pendientes -->
                    <button 
                        (click)="cambiarPestana('pendientes')"
                        [class.border-blue-600]="pestanaActiva() === 'pendientes'"
                        [class.text-blue-600]="pestanaActiva() === 'pendientes'"
                        [class.border-transparent]="pestanaActiva() !== 'pendientes'"
                        [class.text-gray-500]="pestanaActiva() !== 'pendientes'"
                        class="group inline-flex items-center gap-2 px-6 py-4 border-b-2 font-medium text-sm hover:text-blue-600 hover:border-blue-300 transition-all">
                        <span class="relative">
                            Pendientes
                            <span *ngIf="contadores().pendientes > 0"
                                class="absolute -top-2 -right-6 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-yellow-500 rounded-full">
                                {{contadores().pendientes}}
                            </span>
                        </span>
                    </button>

                    <!-- Pestaña: En Proceso -->
                    <button 
                        (click)="cambiarPestana('en_proceso')"
                        [class.border-blue-600]="pestanaActiva() === 'en_proceso'"
                        [class.text-blue-600]="pestanaActiva() === 'en_proceso'"
                        [class.border-transparent]="pestanaActiva() !== 'en_proceso'"
                        [class.text-gray-500]="pestanaActiva() !== 'en_proceso'"
                        class="group inline-flex items-center gap-2 px-6 py-4 border-b-2 font-medium text-sm hover:text-blue-600 hover:border-blue-300 transition-all">
                        <span class="relative">
                            En Proceso
                            <span *ngIf="contadores().enProceso > 0"
                                class="absolute -top-2 -right-6 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-blue-500 rounded-full">
                                {{contadores().enProceso}}
                            </span>
                        </span>
                    </button>

                    <!-- Pestaña: Completadas -->
                    <button 
                        (click)="cambiarPestana('completadas')"
                        [class.border-blue-600]="pestanaActiva() === 'completadas'"
                        [class.text-blue-600]="pestanaActiva() === 'completadas'"
                        [class.border-transparent]="pestanaActiva() !== 'completadas'"
                        [class.text-gray-500]="pestanaActiva() !== 'completadas'"
                        class="group inline-flex items-center gap-2 px-6 py-4 border-b-2 font-medium text-sm hover:text-blue-600 hover:border-blue-300 transition-all">
                        <span class="relative">
                            Completadas
                            <span *ngIf="contadores().completadas > 0"
                                class="absolute -top-2 -right-6 inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-white bg-green-500 rounded-full">
                                {{contadores().completadas}}
                            </span>
                        </span>
                    </button>
                </nav>
            </div>

            <!-- ========================================================== -->
            <!-- CONTENIDO: PESTAÑA PENDIENTES -->
            <!-- ========================================================== -->
            <div *ngIf="pestanaActiva() === 'pendientes'" class="p-6">
                
                <!-- Estado de carga -->
                <div *ngIf="cargando()" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
                    <p class="mt-4 text-sm text-gray-600 font-medium">Cargando facturas pendientes...</p>
                </div>

                <!-- Sin datos -->
                <div *ngIf="!cargando() && facturasPendientes().length === 0" 
                    class="text-center py-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 mb-4">
                        <lucide-icon [img]="CheckCircle" class="w-8 h-8 text-green-600"></lucide-icon>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">¡Todo al día!</h3>
                    <p class="text-sm text-gray-500">No hay facturas pendientes de crear solicitud</p>
                </div>

                <!-- Tabla de facturas pendientes -->
                <div *ngIf="!cargando() && facturasPendientes().length > 0" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Factura</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Emisor</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Factura</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Pendiente Pago</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr *ngFor="let factura of facturasPendientes(); trackBy: trackByFactura" 
                                class="hover:bg-blue-50/50 transition-colors">
                                
                                <!-- Factura -->
                                <td class="px-4 py-3">
                                    <div class="font-semibold text-gray-900">{{factura.numero_factura}}</div>
                                    <div class="text-xs text-gray-500">{{factura.tipo_dte}}</div>
                                </td>

                                <!-- Emisor -->
                                <td class="px-4 py-3">
                                    <div class="text-sm text-gray-900">{{truncateText(factura.nombre_emisor, 35)}}</div>
                                </td>

                                <!-- Tipo -->
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                                        [class]="getColorTipo(factura.tipo_liquidacion).bg + ' ' + getColorTipo(factura.tipo_liquidacion).text">
                                        {{getEtiquetaTipo(factura.tipo_liquidacion)}}
                                    </span>
                                </td>

                                <!-- Fecha -->
                                <td class="px-4 py-3 text-sm text-gray-700">
                                    {{formatFecha(factura.fecha_emision)}}
                                </td>

                                <!-- Total Factura -->
                                <td class="px-4 py-3 text-sm font-semibold text-gray-900">
                                    {{formatMonto(factura.monto_total_factura)}}
                                </td>

                                <!-- Pendiente Pago -->
                                <td class="px-4 py-3 text-sm font-bold text-green-600">
                                    {{formatMonto(factura.monto_pendiente_pago)}}
                                </td>

                                <!-- Acciones -->
                                <td class="px-4 py-3">
                                    <div class="flex items-center justify-center gap-1">
                                        <!-- Ver detalle -->
                                        <button 
                                            (click)="verDetalleFactura(factura)"
                                            title="Ver detalle completo"
                                            class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-all">
                                            <lucide-icon [img]="Eye" class="w-5 h-5"></lucide-icon>
                                        </button>

                                        <!-- Solicitar corrección -->
                                        <button 
                                            (click)="solicitarCorreccion(factura)"
                                            title="Solicitar corrección"
                                            class="p-2 text-orange-600 hover:bg-orange-100 rounded-lg transition-all">
                                            <lucide-icon [img]="AlertCircle" class="w-5 h-5"></lucide-icon>
                                        </button>

                                        <!-- Crear solicitud -->
                                        <button 
                                            (click)="crearSolicitudTransferencia(factura)"
                                            [disabled]="!puedeCrearSolicitud(factura)"
                                            title="Crear solicitud de transferencia"
                                            class="p-2 text-green-600 hover:bg-green-100 rounded-lg transition-all disabled:opacity-30 disabled:cursor-not-allowed">
                                            <lucide-icon [img]="Send" class="w-5 h-5"></lucide-icon>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Footer -->
                    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
                        <p class="text-sm text-gray-600">
                            Mostrando <span class="font-semibold text-blue-600">{{facturasPendientes().length}}</span> 
                            factura(s) pendiente(s)
                        </p>
                    </div>
                </div>
            </div>

            <!-- ========================================================== -->
            <!-- CONTENIDO: PESTAÑA EN PROCESO -->
            <!-- ========================================================== -->
            <div *ngIf="pestanaActiva() === 'en_proceso'" class="p-6">
                
                <!-- Estado de carga -->
                <div *ngIf="cargando()" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
                    <p class="mt-4 text-sm text-gray-600 font-medium">Cargando solicitudes en proceso...</p>
                </div>

                <!-- Sin datos -->
                <div *ngIf="!cargando() && facturasEnProceso().length === 0" 
                    class="text-center py-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-blue-100 mb-4">
                        <lucide-icon [img]="FileText" class="w-8 h-8 text-blue-600"></lucide-icon>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Sin solicitudes en proceso</h3>
                    <p class="text-sm text-gray-500">No hay solicitudes pendientes de aprobar o aprobadas</p>
                </div>

                <!-- Tabla de facturas en proceso -->
                <div *ngIf="!cargando() && facturasEnProceso().length > 0" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Factura</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Código Solicitud</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Monto Solicitud</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Banco</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr *ngFor="let factura of facturasEnProceso(); trackBy: trackByFactura" 
                                class="hover:bg-blue-50/50 transition-colors">
                                
                                <!-- Factura -->
                                <td class="px-4 py-3">
                                    <div class="font-semibold text-gray-900">{{factura.numero_factura}}</div>
                                    <div class="text-xs text-gray-500">{{truncateText(factura.nombre_emisor, 25)}}</div>
                                </td>

                                <!-- Código Solicitud -->
                                <td class="px-4 py-3">
                                    <div class="font-mono font-semibold text-blue-600">
                                        {{factura.solicitud?.codigo_solicitud}}
                                    </div>
                                </td>

                                <!-- Tipo -->
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                                        [class]="getColorTipo(factura.tipo_liquidacion).bg + ' ' + getColorTipo(factura.tipo_liquidacion).text">
                                        {{getEtiquetaTipo(factura.tipo_liquidacion)}}
                                    </span>
                                </td>

                                <!-- Estado -->
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                                        [class]="getColorEstado(factura.solicitud!.estado).bg + ' ' + getColorEstado(factura.solicitud!.estado).text">
                                        {{getEtiquetaEstado(factura.solicitud!.estado)}}
                                    </span>
                                </td>

                                <!-- Monto Solicitud -->
                                <td class="px-4 py-3 text-sm font-bold text-green-600">
                                    {{formatMonto(factura.solicitud!.monto_total_solicitud)}}
                                </td>

                                <!-- Banco -->
                                <td class="px-4 py-3 text-sm text-gray-700">
                                    {{factura.solicitud?.banco_nombre}}
                                </td>

                                <!-- Acciones -->
                                <td class="px-4 py-3">
                                    <div class="flex items-center justify-center gap-1">
                                        <!-- Ver detalle -->
                                        <button 
                                            (click)="verDetalleFactura(factura)"
                                            title="Ver detalle"
                                            class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-all">
                                            <lucide-icon [img]="Eye" class="w-5 h-5"></lucide-icon>
                                        </button>

                                        <!-- Registrar comprobante (solo si aprobado) -->
                                        <button 
                                            *ngIf="mostrarBotonRegistrarComprobante(factura)"
                                            (click)="registrarComprobante(factura)"
                                            title="Registrar comprobante"
                                            class="p-2 text-green-600 hover:bg-green-100 rounded-lg transition-all">
                                            <lucide-icon [img]="CheckCircle" class="w-5 h-5"></lucide-icon>
                                        </button>

                                        <!-- Cancelar (solo si pendiente) -->
                                        <button 
                                            *ngIf="mostrarBotonCancelar(factura)"
                                            (click)="cancelarSolicitud(factura)"
                                            title="Cancelar solicitud"
                                            class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition-all">
                                            <lucide-icon [img]="X" class="w-5 h-5"></lucide-icon>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Footer -->
                    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
                        <p class="text-sm text-gray-600">
                            Mostrando <span class="font-semibold text-blue-600">{{facturasEnProceso().length}}</span> 
                            solicitud(es) en proceso
                        </p>
                    </div>
                </div>
            </div>

            <!-- ========================================================== -->
            <!-- CONTENIDO: PESTAÑA COMPLETADAS -->
            <!-- ========================================================== -->
            <div *ngIf="pestanaActiva() === 'completadas'" class="p-6">
                
                <!-- Estado de carga -->
                <div *ngIf="cargando()" class="text-center py-12">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent"></div>
                    <p class="mt-4 text-sm text-gray-600 font-medium">Cargando solicitudes completadas...</p>
                </div>

                <!-- Sin datos -->
                <div *ngIf="!cargando() && facturasCompletadas().length === 0" 
                    class="text-center py-12">
                    <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-gray-100 mb-4">
                        <lucide-icon [img]="FileText" class="w-8 h-8 text-gray-400"></lucide-icon>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-2">Sin historial</h3>
                    <p class="text-sm text-gray-500">No hay solicitudes completadas o canceladas</p>
                </div>

                <!-- Tabla de facturas completadas -->
                <div *ngIf="!cargando() && facturasCompletadas().length > 0" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Código</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Factura</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Tipo</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Estado</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Monto</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Fecha Comp.</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr *ngFor="let factura of facturasCompletadas(); trackBy: trackByFactura" 
                                class="hover:bg-gray-50 transition-colors">
                                
                                <!-- Código -->
                                <td class="px-4 py-3">
                                    <div class="font-mono font-semibold text-blue-600">
                                        {{factura.solicitud?.codigo_solicitud}}
                                    </div>
                                </td>

                                <!-- Factura -->
                                <td class="px-4 py-3">
                                    <div class="font-semibold text-gray-900">{{factura.numero_factura}}</div>
                                    <div class="text-xs text-gray-500">{{truncateText(factura.nombre_emisor, 25)}}</div>
                                </td>

                                <!-- Tipo -->
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                                        [class]="getColorTipo(factura.tipo_liquidacion).bg + ' ' + getColorTipo(factura.tipo_liquidacion).text">
                                        {{getEtiquetaTipo(factura.tipo_liquidacion)}}
                                    </span>
                                </td>

                                <!-- Estado -->
                                <td class="px-4 py-3">
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium"
                                        [class]="getColorEstado(factura.solicitud!.estado).bg + ' ' + getColorEstado(factura.solicitud!.estado).text">
                                        {{getEtiquetaEstado(factura.solicitud!.estado)}}
                                    </span>
                                </td>

                                <!-- Monto -->
                                <td class="px-4 py-3 text-sm font-semibold text-gray-900">
                                    {{formatMonto(factura.solicitud!.monto_total_solicitud)}}
                                </td>

                                <!-- Fecha Comprobante -->
                                <td class="px-4 py-3 text-sm text-gray-700">
                                    {{ formatFecha(factura.solicitud?.fecha_transferencia) }}
                                </td>

                                <!-- Acciones -->
                                <td class="px-4 py-3">
                                    <div class="flex items-center justify-center gap-1">
                                        <!-- Ver detalle -->
                                        <button 
                                            (click)="verDetalleFactura(factura)"
                                            title="Ver detalle"
                                            class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-all">
                                            <lucide-icon [img]="Eye" class="w-5 h-5"></lucide-icon>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <!-- Footer -->
                    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
                        <p class="text-sm text-gray-600">
                            Mostrando <span class="font-semibold text-blue-600">{{facturasCompletadas().length}}</span> 
                            solicitud(es) en historial
                        </p>
                    </div>
                </div>
            </div>

        </div>

    </div>
</div>

<!-- ================================================================ -->
<!-- MODALES (Descomentar cuando se creen los componentes) -->
<!-- ================================================================ -->

<!-- Modal: Ver Detalle de Factura -->
<app-modal-ver-detalle-factura
    *ngIf="mostrarModalDetalle()"
    [factura]="facturaSeleccionada()"
    (cerrar)="cerrarModalDetalle()">
</app-modal-ver-detalle-factura> 

<!-- Modal: Crear Solicitud -->
<app-modal-crear-solicitud
    *ngIf="mostrarModalCrear()"
    [factura]="facturaSeleccionada()"
    (cerrar)="cerrarModalCrear()"
    (confirmado)="onSolicitudCreada()">
</app-modal-crear-solicitud>

<!-- Modal: Registrar Comprobante -->
<app-modal-registrar-comprobante *ngIf="mostrarModalComprobante()"
    [solicitud]="facturaSeleccionada()?.solicitud ?? null" (cerrar)="cerrarModalComprobante()"
    (confirmado)="onComprobanteRegistrado()">
</app-modal-registrar-comprobante>