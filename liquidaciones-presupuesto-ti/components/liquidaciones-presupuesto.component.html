<!-- ============================================================================ -->
<!-- TEMPLATE HTML COMPLETO - LIQUIDACIONES POR PRESUPUESTO (ACTUALIZADO) -->
<!-- ============================================================================ -->

<!-- Mesa de Trabajo Superior -->
<div class="fixed left-0 right-0 bg-white shadow-md border-b border-gray-200 z-50" [style.top.px]="offsetTop()"
    [style.transition]="headerEstaFijo() ? 'none' : 'top 0.1s ease-out'">
    <div class="mx-auto px-4">
        <!-- Header Principal -->
        <div class="flex items-center justify-between h-12 border-b border-gray-100">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z">
                        </path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-gray-900">Sistema de Liquidación - Área TI</h1>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Indicador de Estado -->
                <div class="flex items-center gap-1 text-sm">
                    <div class="w-2 h-2 rounded-full bg-green-500" [class.bg-red-500]="error()"
                        [class.bg-yellow-500]="cargando()"></div>
                    <span class="text-gray-600">
                        <span *ngIf="cargando()">Cargando...</span>
                        <span *ngIf="error()">Error</span>
                        <span *ngIf="!cargando() && !error()">Listo</span>
                    </span>
                </div>
                <div class="flex items-center gap-3">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" [checked]="todosMarcados()"
                            [indeterminate]="algunoMarcado() && !todosMarcados()"
                            (click)="toggleSeleccionGlobal($event)"
                            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label class="text-sm font-medium text-gray-700">Seleccionar todo</label>
                    </div>
                    <div class="text-sm">
                        <span class="font-medium text-blue-700">{{estadisticas().detallesSeleccionados}}</span>
                        <span class="text-gray-500">de {{estadisticas().totalDetalles}} </span>
                    </div>
                </div>
                <!-- Botón Descargar Excel -->
                <button (click)="descargarTablaGastos()" [disabled]="liquidaciones().length === 0"
                    class="w-10 h-10 bg-green-50 text-green-700 rounded-md hover:bg-green-100 disabled:opacity-50 transition-colors flex items-center justify-center"
                    title="Descargar Excel">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                </button>
                <!-- Botón Refrescar -->
                <button (click)="refrescarDatos()" [disabled]="cargando()"
                    class="w-10 h-10 bg-blue-50 text-blue-700 rounded-md hover:bg-blue-100 disabled:opacity-50 transition-colors flex items-center justify-center">
                    <svg class="w-4 h-4" [class.animate-spin]="cargando()" fill="none" stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                        </path>
                    </svg>
                </button>
                <!-- Botón Verificar -->
                <button (click)="verificarSeleccionados()"
                    [disabled]="estadisticas().detallesSeleccionados === 0 || cargando()"
                    class="w-10 h-10 bg-green-600 hover:bg-green-700 text-white rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                    title="Verificar Seleccionados">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7">
                        </path>
                    </svg>
                </button>
                <!-- Botón Comprobante -->
                <button (click)="asignarComprobanteSeleccionados()"
                    [disabled]="estadisticas().detallesSeleccionados === 0 || cargando()"
                    class="w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-md transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center"
                    title="Asignar Comprobante">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                        </path>
                    </svg>
                </button>
                <!-- Botón Limpiar Selección -->
                <button (click)="limpiarSelecciones()" [disabled]="estadisticas().detallesSeleccionados === 0"
                    class="w-10 h-10 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-md transition-colors flex items-center justify-center"
                    title="Limpiar Selecciones">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
                <!-- Botón Limpiar Filtros -->
                <button (click)="limpiarFiltros()"
                    class="w-10 h-10 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-md transition-colors flex items-center justify-center"
                    title="Limpiar Todos los Filtros">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z">
                        </path>
                    </svg>
                </button>
                <!-- NUEVO: Botón Limpiar Solo Fecha -->
                <button (click)="limpiarFiltroFecha()" [disabled]="!formularioFiltros.get('fechaDesde')?.value"
                    class="w-10 h-10 bg-red-100 hover:bg-red-200 text-red-700 rounded-md transition-colors flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed"
                    title="Limpiar Filtro de Fecha">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" width="128" height="128" viewBox="0 0 24 24">
                        <path fill="none" stroke="#D10202FF" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M21 21H8a2 2 0 0 1-1.42-.587l-3.994-3.999a2 2 0 0 1 0-2.828l10-10a2 2 0 0 1 2.829 0l5.999 6a2 2 0 0 1 0 2.828L12.834 21m-7.752-9.91l8.828 8.828" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Sección de Filtros ACTUALIZADA -->
        <div class="mb-1.5 border-b border-gray-100">
            <h2 class="text-sm font-semibold text-gray-800 mb-2">Filtros de Búsqueda</h2>
            <form [formGroup]="formularioFiltros"
                class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-2">

                <!-- NUEVO: Selector de tipo de búsqueda -->
                <div class="relative">
                    <select formControlName="tipoBusqueda"
                        class="block w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="factura">Núm. Factura</option>
                        <option value="orden">Núm. Orden</option>
                        <option value="usuario">Usuario</option>
                    </select>
                </div>

                <!-- NUEVO: Campo de búsqueda unificado -->
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                        <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z">
                            </path>
                        </svg>
                    </div>
                    <input type="text" formControlName="valorBusqueda" placeholder="Buscar..."
                        class="block w-full pl-8 pr-2 py-1.5 border border-gray-300 rounded-md text-sm bg-white placeholder-gray-500 focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                </div>

                <!-- NUEVO: Filtro de fecha con indicador -->
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
                        <svg class="h-4 w-4" [class.text-green-500]="formularioFiltros.get('fechaDesde')?.value"
                            [class.text-gray-400]="!formularioFiltros.get('fechaDesde')?.value" fill="none"
                            stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
                            </path>
                        </svg>
                    </div>
                    <input type="date" formControlName="fechaDesde"
                        [class.border-green-500]="formularioFiltros.get('fechaDesde')?.value"
                        [class.bg-green-50]="formularioFiltros.get('fechaDesde')?.value"
                        class="block w-full pl-8 pr-2 py-1.5 border border-gray-300 rounded-md text-sm bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                    <!-- Indicador de fecha guardada -->
                    <div *ngIf="formularioFiltros.get('fechaDesde')?.value"
                        class="absolute inset-y-0 right-0 pr-2 flex items-center pointer-events-none">
                        <span class="text-xs font-medium text-green-600">●</span>
                    </div>
                </div>

                <!-- Filtro Método de Pago ACTUALIZADO -->
                <div class="relative">
                    <select formControlName="metodoPago"
                        class="block w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="">Método de Pago</option>
                        <option value="anticipo">Anticipo</option>
                        <option value="cheque">Cheque</option>
                        <option value="contrasena">Contraseña</option>
                        <option value="costoasumido">Costo Asumido</option>
                        <option value="deposito">Depósito</option>
                        <option value="tarjeta">Tarjeta</option>
                        <option value="transferencia">Transferencia</option>
                    </select>
                </div>

                <!-- Filtro Estado Verificación -->
                <div class="relative">
                    <select formControlName="estadoVerificacion"
                        class="block w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="">Estado Verificación</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="verificado">Verificado</option>
                    </select>
                </div>

                <!-- Filtro Estado Liquidación -->
                <div class="relative">
                    <select formControlName="estadoLiquidacion"
                        class="block w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm bg-white focus:outline-none focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition duration-150">
                        <option value="">Estado Liquidación</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Correcion">Corrección</option>
                        <option value="Verificado">Verificado</option>
                        <option value="Liquidado">Liquidado</option>
                        <option value="Pagado">Pagado</option>
                    </select>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Contenido Principal con Espaciado Superior DINÁMICO -->
<div class="transition-all duration-300" [class.pt-32]="!headerEstaFijo()" [class.pt-36]="headerEstaFijo()">

    <!-- Mensaje de Error -->
    <div *ngIf="error()" class="mx-4 mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
        <div class="flex items-center">
            <svg class="h-5 w-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="ml-2 text-sm text-red-800 font-medium">{{error()}}</span>
        </div>
    </div>

    <!-- Indicador de Carga -->
    <div *ngIf="cargando()" class="flex justify-center items-center py-12">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600 font-medium">Cargando liquidaciones...</p>
            <p class="text-sm text-gray-500">Por favor espere</p>
        </div>
    </div>

    <!-- Lista de Liquidaciones -->
    <div class="space-y-4" *ngIf="!cargando()">

        <!-- Mensaje cuando no hay datos -->
        <div *ngIf="liquidaciones().length === 0" class="text-center py-16">
            <svg class="mx-auto h-16 w-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                </path>
            </svg>
            <h3 class="text-lg font-medium text-gray-900 mb-2">No hay liquidaciones disponibles</h3>
            <p class="text-gray-500 mb-4">No se encontraron liquidaciones que coincidan con los filtros aplicados.</p>
            <button (click)="limpiarFiltros()"
                class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-lg text-blue-700 bg-blue-100 hover:bg-blue-200 transition-all duration-200">
                Limpiar filtros
            </button>
        </div>

        <!-- Tarjetas de Liquidaciones por Factura -->
        <div *ngFor="let liquidacion of liquidaciones(); trackBy: trackByFactura"
            class="bg-white border border-gray-200 rounded-md shadow-sm overflow-hidden">
            <!-- Resumen de Factura -->
            <div class="bg-blue-600 text-white p-2 flex items-center justify-between">
                <div class="flex items-center">
                    <input type="checkbox" [checked]="facturaCompleta(liquidacion)"
                        [indeterminate]="facturaIndeterminada(liquidacion)"
                        (click)="toggleSeleccionFactura(liquidacion.factura.numero_dte, $event)"
                        class="h-3.5 w-3.5 my-auto text-blue-600 bg-white border-2 border-white rounded focus:ring-2 focus:ring-blue-400">
                    <h2 class="text-lg font-bold ml-2">Factura: {{liquidacion.factura.numero_dte}}</h2>
                </div>
            </div>

            <!-- Tabla Resumen Factura -->
            <div class="bg-white">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-200">
                            <tr>
                                <th
                                    class="p-0.5 px-2 text-xs uppercase font-semibold text-gray-600 whitespace-nowrap border-r border-gray-200 last:border-r-0">
                                    Estado</th>
                                <th
                                    class="p-0.5 px-2 text-xs uppercase font-semibold text-gray-600 whitespace-nowrap border-r border-gray-200 last:border-r-0">
                                    Emisor</th>
                                <th
                                    class="p-0.5 px-2 text-xs uppercase font-semibold text-gray-600 whitespace-nowrap border-r border-gray-200 last:border-r-0">
                                    Tipo DTE</th>
                                <th
                                    class="p-0.5 px-2 text-xs uppercase font-semibold text-gray-600 whitespace-nowrap border-r border-gray-200 last:border-r-0">
                                    Fecha Emisión</th>
                                <th
                                    class="p-0.5 px-2 text-xs uppercase font-semibold text-gray-600 whitespace-nowrap border-r border-gray-200 last:border-r-0">
                                    Estado Factura</th>
                                <th
                                    class="p-0.5 px-2 text-xs uppercase font-semibold text-gray-600 whitespace-nowrap border-r border-gray-200 last:border-r-0">
                                    Total Factura</th>
                                <th
                                    class="p-0.5 px-2 text-xs uppercase font-semibold text-gray-600 whitespace-nowrap border-r border-gray-200 last:border-r-0">
                                    Total Liquidado</th>
                                <th
                                    class="p-0.5 px-2 text-xs uppercase font-semibold text-gray-600 whitespace-nowrap border-r border-gray-200 last:border-r-0">
                                    Retención</th>
                                <th
                                    class="p-0.5 px-2 text-xs uppercase font-semibold text-gray-600 whitespace-nowrap border-r border-gray-200 last:border-r-0">
                                    Total Pendiente</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td
                                    class="text-center px-2 font-medium text-gray-800 text-sm align-middle border-r border-gray-200 last:border-r-0">
                                    <span class="inline-flex px-1 py-1 text-sm font-medium rounded-md"
                                        [ngClass]="getColorEstadoLiquidacion(liquidacion.factura.estado_liquidacion)">
                                        {{liquidacion.factura.estado_liquidacion}}
                                    </span>
                                </td>
                                <td
                                    class="px-2 font-medium text-gray-800 text-sm align-middle border-r border-gray-200 last:border-r-0">
                                    {{liquidacion.factura.nombre_emisor}}</td>
                                <td
                                    class="px-2 font-medium text-gray-800 text-sm align-middle border-r border-gray-200 last:border-r-0">
                                    {{liquidacion.factura.tipo_dte}}</td>
                                <td
                                    class="px-2 font-medium text-gray-800 text-sm align-middle border-r border-gray-200 last:border-r-0">
                                    {{liquidacion.factura.fecha_emision}}</td>
                                <td
                                    class="text-right px-2 font-bold text-gray-600 text-lg align-middle border-r border-gray-200 last:border-r-0">
                                    {{liquidacion.factura.estado}}</td>
                                <td
                                    class="text-right px-2 font-bold text-green-600 text-lg align-middle border-r border-gray-200 last:border-r-0">
                                    {{formatMonto(liquidacion.factura.monto_total)}}</td>
                                <td
                                    class="text-right px-2 font-bold text-green-600 text-lg align-middle border-r border-gray-200 last:border-r-0">
                                    {{formatMonto(liquidacion.factura.monto_total_liquidado)}}</td>
                                <td
                                    class="text-right px-2 font-bold text-red-600 text-lg align-middle border-r border-gray-200 last:border-r-0">
                                    {{formatMonto(liquidacion.factura.monto_total_retencion)}}</td>
                                <td
                                    class="bg-blue-50 font-bold text-blue-600 text-xl text-right p-0.5 px-2 border-t border-b border-blue-600 align-middle">
                                    {{
                                    formatMonto(
                                    liquidacion.factura.total_a_depositar < 0 ? 0 :
                                        liquidacion.factura.total_a_depositar ) }} </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tabla de Detalles -->
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-200 divide-y divide-gray-400">
                        <tr>
                            <th
                                class="w-8 p-0.5 px-2 text-center font-medium text-gray-700 text-xs leading-none border-r border-gray-200">
                            </th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Orden</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Nombre Gasto</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Agencia Gasto</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Descripción</th>
                            <th
                                class="p-0.5 px-2 text-right font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Monto</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Área/Presupuesto</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Cuenta Contable</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Fecha Creación</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Fecha Modificación</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Forma de Pago</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Datos de Pago</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Datos de Tesoreria</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Usuario</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Estado Verificacion</th>
                            <th
                                class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                Acciones</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <tr *ngFor="let detalle of liquidacion.detalles; trackBy: trackByDetalle"
                            class="hover:bg-gray-50 transition-colors duration-200"
                            [class.bg-blue-50]="detalle.seleccionado">

                            <td class="p-0.5 px-2 text-center border-r border-gray-200 last:border-r-0">
                                <input type="checkbox" [checked]="detalle.seleccionado"
                                    (click)="toggleSeleccionDetalle(detalle.id, $event)"
                                    class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                            </td>
                            <td
                                class="p-0.5 px-2 text-gray-900 font-medium text-sm leading-tight border-r border-gray-200 last:border-r-0 min-w-52">
                                <div class="text-sm font-medium text-gray-900">{{detalle.numero_orden}}</div>
                                <div class="text-xs text-gray-500">Anticipos: {{formatMonto(detalle.total_anticipos)}} - 
                                </div>
                                <div class="text-xs text-gray-500">Liq/Ren:
                                    {{formatMonto(detalle.total_liquidaciones_anticipo)}} + {{formatMonto(detalle.total_reintegros_anticipo)}} = {{formatMonto(detalle.saldo_anticipo)}}
                                </div>                                    
                            </td>
                            <td
                                class="p-0.5 px-2 text-gray-900 text-sm leading-tight border-r border-gray-200 last:border-r-0 min-w-72">
                                {{detalle.nombre_gasto}}</td>
                            <td
                                class="p-0.5 px-2 text-gray-900 text-sm leading-tight border-r border-gray-200 last:border-r-0 min-w-64">
                                {{detalle.agencia_gasto}}</td>
                            <td
                                class="p-0.5 px-2 text-gray-900 text-sm leading-tight border-r border-gray-200 last:border-r-0 min-w-72">
                                {{truncateText(detalle.descripcion, 60)}}</td>
                            <td
                                class="p-0.5 px-2 text-right text-green-600 font-medium text-sm leading-tight border-r border-gray-200 last:border-r-0">
                                {{detalle.monto}}</td>
                            <td
                                class="p-0.5 px-2 text-gray-700 text-sm leading-tight border-r border-gray-200 last:border-r-0">
                                <div *ngIf="detalle.area_presupuesto" class="text-xs text-blue-600 mt-1">
                                    {{detalle.area_presupuesto}}/{{detalle.nombre_presupuesto}}</div>
                            </td>
                            <td
                                class="p-0.5 px-2 text-gray-700 text-sm leading-tight border-r border-gray-200 last:border-r-0">
                                <div *ngIf="detalle.area_presupuesto" class="text-xs text-blue-600 mt-1">
                                    {{detalle.cuenta_contable}}</div>
                            </td>
                            <td
                                class="p-0.5 px-2 text-gray-600 text-sm leading-tight border-r border-gray-200 last:border-r-0">
                                {{formatFecha(detalle.fecha_creacion)}}</td>
                            <td
                                class="p-0.5 px-2 text-gray-600 text-sm leading-tight border-r border-gray-200 last:border-r-0">
                                {{formatFecha(detalle.fecha_actualizacion)}}</td>
                            <td
                                class="p-0.5 px-2 text-gray-700 text-sm leading-tight border-r border-gray-200 last:border-r-0">
                                <span class="inline-flex px-2 py-1 text-xs font-medium rounded-full capitalize"
                                    [ngClass]="getColorFormaPago(detalle.forma_pago)">{{detalle.forma_pago}}</span>
                            </td>
                            <td
                                class="p-0.5 px-2 text-gray-600 text-sm leading-tight border-r border-gray-200 last:border-r-0 min-w-72">
                                <div [innerHTML]="obtenerDatosPago(detalle)"></div>
                            </td>
                            <td
                                class="p-0.5 px-2 text-gray-600 text-sm leading-tight border-r border-gray-200 last:border-r-0 min-w-72">
                                <div *ngIf="detalle.comprobante_tesoreria" class="text-xs text-green-600">
                                    <div [innerHTML]="obtenerDatosTesoreria(detalle)"></div>
                                </div>
                                <div *ngIf="!detalle.comprobante_tesoreria" class="text-xs text-gray-400">Sin
                                    comprobante</div>
                            </td>
                            <td
                                class="p-0.5 px-2 text-gray-600 text-sm leading-tight border-r border-gray-200 last:border-r-0 min-w-72">
                                {{detalle.usuario}}</td>
                            <td
                                class="p-0.5 px-2 text-gray-700 text-sm leading-tight border-r border-gray-200 last:border-r-0 min-w-36">
                                <div class="flex flex-col gap-2">
                                    <span
                                        class="inline-flex px-2 py-1 text-xs font-medium rounded-full capitalize max-w-20"
                                        [ngClass]="getColorEstadoVerificacion(detalle.estado_verificacion)">{{detalle.estado_verificacion}}</span>
                                    <div *ngIf="detalle.tiene_cambios_pendientes">
                                        <span
                                            class="inline-flex px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-700">Cambios
                                            Pendientes</span>
                                    </div>
                                    <div *ngIf="detalle.comprobante_contabilidad" class="text-xs text-green-600">Comp:
                                        {{detalle.comprobante_contabilidad}}</div>
                                </div>
                            </td>
                            <td class="p-0.5 px-2 border-r border-gray-200 last:border-r-0">
                                <div class="flex items-center justify-center gap-1">
                                    <!-- Ver Detalle Completo -->
                                    <button (click)="verDetalleCompleto(detalle)"
                                        class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors duration-200"
                                        title="Ver Detalle Completo">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
                                            </path>
                                        </svg>
                                    </button>
                                    <!-- Verificar -->
                                    <button (click)="verificarDetalle(detalle)"
                                        class="p-2 text-green-600 hover:bg-green-50 rounded-lg transition-colors duration-200"
                                        title="Verificar Detalle">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 13l4 4L19 7"></path>
                                        </svg>
                                    </button>
                                    <!-- Solicitar Cambio -->
                                    <button (click)="solicitarCambioDetalle(detalle)"
                                        [disabled]="!puedeSolicitarCambio(detalle)"
                                        class="p-2 text-orange-600 hover:bg-orange-50 rounded-lg transition-colors duration-200 disabled:opacity-40 disabled:cursor-not-allowed"
                                        title="Solicitar Cambio">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                            </path>
                                        </svg>
                                    </button>
                                    <!-- Ver Cambios CON CONTADOR -->
                                    <button (click)="verCambiosDetalle(detalle)"
                                        [disabled]="detalle.cantidad_cambios === 0"
                                        class="p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition-colors duration-200 disabled:opacity-40 disabled:cursor-not-allowed relative"
                                        title="Ver Cambios Solicitados">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z" />
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z" />
                                        </svg>
                                        <!-- Contador de cambios -->
                                        <span *ngIf="detalle.cantidad_cambios > 0"
                                            class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full px-1.5 py-0.5 min-w-[18px] h-[18px] flex items-center justify-center">{{
                                            detalle.cantidad_cambios }}</span>
                                    </button>
                                    <!-- Asignar Comprobante -->
                                    <button (click)="asignarComprobanteDetalle(detalle)"
                                        class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-lg transition-colors duration-200"
                                        title="Asignar Comprobante">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Sección de Retenciones -->
            <div *ngIf="liquidacion.retenciones.length > 0" class="border-t border-gray-200">
                <div class="bg-gray-200 px-2 py-2 border-b border-gray-200">
                    <h4 class="text-xs font-semibold text-gray-700 uppercase flex items-center gap-2">
                        <svg class="w-3 h-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z">
                            </path>
                        </svg>
                        Retenciones ({{liquidacion.retenciones.length}})
                    </h4>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-200">
                            <tr>
                                <th
                                    class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                    Código</th>
                                <th
                                    class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                    Nombre</th>
                                <th
                                    class="p-0.5 px-2 text-right font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                    Monto</th>
                                <th
                                    class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                    Cuenta Contable</th>
                                <th
                                    class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                    Fecha</th>
                                <th
                                    class="p-0.5 px-2 text-left font-medium text-gray-700 text-xs leading-none border-r border-gray-200 last:border-r-0">
                                    Creado Por</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <tr *ngFor="let retencion of liquidacion.retenciones" class="hover:bg-gray-50">
                                <td
                                    class="p-0.5 px-2 text-sm font-medium text-gray-900 border-r border-gray-200 last:border-r-0">
                                    {{retencion.codigo || 'N/A'}}</td>
                                <td class="p-0.5 px-2 text-sm text-gray-900 border-r border-gray-200 last:border-r-0">
                                    {{retencion.nombre}}</td>
                                <td
                                    class="p-0.5 px-2 text-sm font-bold text-red-600 text-right border-r border-gray-200 last:border-r-0">
                                    {{formatMonto(retencion.monto)}}</td>
                                <td class="p-0.5 px-2 text-sm text-gray-600 border-r border-gray-200 last:border-r-0">
                                    {{retencion.cuenta_contable || 'N/A'}}</td>
                                <td class="p-0.5 px-2 text-sm text-gray-600 border-r border-gray-200 last:border-r-0">
                                    {{formatFecha(retencion.fecha_retencion)}}</td>
                                <td class="p-0.5 px-2 text-sm text-gray-600 border-r border-gray-200 last:border-r-0">
                                    {{retencion.creado_por_nombre || 'N/A'}}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Botón Scroll to Top -->
<button (click)="scrollToTop()"
    class="fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-full shadow-lg transition-all duration-300 z-40"
    [class.opacity-0]="liquidaciones().length === 0" [class.pointer-events-none]="liquidaciones().length === 0">
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18"></path>
    </svg>
</button>

<!-- ============================================================================ -->
<!-- MODALES -->
<!-- ============================================================================ -->

<!-- Modal Comprobante -->
<app-modal-comprobante-ti *ngIf="mostrarModalComprobante()" [modo]="modoComprobante()"
    [detalles]="modoComprobante() === 'individual' ? [detalleSeleccionadoModal()!] : service.obtenerDetallesSeleccionados()"
    [agencias]="service.obtenerAgenciasActuales()" (cerrar)="cerrarModalComprobante()"
    (confirmado)="onComprobanteConfirmado($event)">
</app-modal-comprobante-ti>

<!-- Modal Solicitar Cambio -->
<app-modal-solicitar-cambio-ti *ngIf="mostrarModalCambio()" [detalle]="detalleSeleccionadoModal()"
    (cerrar)="cerrarModalCambio()" (confirmado)="onCambioConfirmado($event)">
</app-modal-solicitar-cambio-ti>

<!-- Modal Ver Cambios -->
<app-modal-ver-cambios-ti *ngIf="mostrarModalVerCambios()" [detalle]="detalleSeleccionadoModal()"
    (cerrar)="cerrarModalVerCambios()">
</app-modal-ver-cambios-ti>

<!-- Modal Ver Detalle Completo -->
<app-modal-ver-detalle-ti *ngIf="mostrarModalVerDetalle()" [detalle]="detalleSeleccionadoModal()"
    [factura]="facturaSeleccionadaModal()" [retenciones]="retencionesSeleccionadasModal()"
    (cerrar)="cerrarModalVerDetalle()">
</app-modal-ver-detalle-ti>