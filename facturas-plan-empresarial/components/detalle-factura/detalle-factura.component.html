<!-- components/detalle-factura/detalle-factura.component.html -->
<div class="w-full flex flex-col h-80">
    <div
        class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-gray-200 dark:border-gray-700 overflow-hidden flex-grow flex flex-col">

        <!-- Header -->
        <div class="p-3 border-b border-gray-200 dark:border-gray-600 flex justify-between items-center">
            <h2 class="text-lg font-extrabold text-gray-900 dark:text-white">
                Detalle de <span
                    class="text-transparent bg-clip-text bg-gradient-to-r to-blue-600 from-indigo-400">Factura</span>
            </h2>
            <button (click)="abrirRegistrar()"
                class="text-gray-400 hover:text-gray-500 p-1 rounded-full transition-colors"
                title="Registrar nueva factura">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>

        <!-- Buscador -->
        <div class="px-2 py-1 border-b border-gray-100 dark:border-gray-700">
            <div class="flex gap-2">
                <input [formControl]="searchControl" type="search" class="pl-3 pr-3 py-2 block w-full text-sm text-gray-900 border border-gray-300 rounded-md bg-white
                        focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500
                        dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"
                    placeholder="Ingrese número DTE y presione Enter o espere (mín. 3 caracteres)" />
                <button (click)="buscarManual()"
                    class="px-3 py-2 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Buscar
                </button>

                <!-- Botones de acción cuando hay factura -->
                <ng-container *ngIf="(factura$ | async) as f">
                    <!-- Botón Liquidar (cuando puede liquidar normalmente) -->
                    <button *ngIf="puedeLiquidar(f)"
                        class="px-3 py-2 text-xs bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors"
                        (click)="onLiquidar(f)">
                        Liquidar
                    </button>

                    <!-- Botón Solicitar Autorización (cuando requiere autorización) -->
                    <button *ngIf="requiereAutorizacion(f)"
                        class="px-3 py-2 text-xs bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors"
                        (click)="onLiquidar(f)">
                        Solicitar Autorización
                    </button>

                    <!-- Botón deshabilitado (cuando no se puede liquidar) -->
                    <button *ngIf="liquidarDeshabilitado(f)"
                        class="px-3 py-2 text-xs bg-gray-300 text-gray-500 rounded-md cursor-not-allowed" disabled>
                        No Liquidable
                    </button>
                </ng-container>
            </div>
        </div>

        <!-- Loading -->
        <div *ngIf="(loading$ | async)" class="flex-1 grid place-items-center p-6">
            <div class="flex items-center space-x-2 text-gray-500">
                <div class="w-6 h-6 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin"></div>
                <span class="text-sm">Cargando...</span>
            </div>
        </div>

        <!-- Sin factura -->
        <div *ngIf="!(loading$ | async) && !(factura$ | async)"
            class="flex-1 grid place-items-center p-6 text-sm text-gray-500">
            Busque una factura para ver su detalle
        </div>

        <!-- Detalle de factura -->
        <ng-container *ngIf="!(loading$ | async) && (factura$ | async) as f">
            <div class="px-2 py-1 overflow-auto">

                <!-- Badges de estado -->
                <div class="flex flex-wrap gap-2 mb-3">
                    <!-- Badge estado liquidación -->
                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold" [ngClass]="{
                        'bg-green-100 text-green-800'  : f.estado_liquidacion==='Liquidado',
                        'bg-blue-100 text-blue-800'    : f.estado_liquidacion==='En Revisión',
                        'bg-yellow-100 text-yellow-800': f.estado_liquidacion==='Pendiente'
                    }">
                        {{ f.estado_liquidacion }}
                    </span>

                    <!-- Badge de vencimiento usando tu servicio existente -->
                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold"
                        [ngClass]="validacionVencimiento?.excedeDias ? 'bg-red-100 text-red-800' : 'bg-emerald-100 text-emerald-800'">
                        <span *ngIf="cargandoValidacion">Validando...</span>
                        <span *ngIf="!cargandoValidacion && validacionVencimiento">
                            {{ validacionVencimiento.excedeDias ? 'Fuera de tiempo' : 'Dentro de tiempo' }}
                            ({{ validacionVencimiento.diasTranscurridos }} días)
                        </span>
                        <span *ngIf="!cargandoValidacion && !validacionVencimiento">Sin validar</span>
                    </span>

                    <!-- Badge estado autorización -->
                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold capitalize" [ngClass]="{
                        'bg-green-100 text-green-800' : f.estado_autorizacion==='aprobada',
                        'bg-amber-100 text-amber-800' : f.estado_autorizacion==='pendiente',
                        'bg-red-100 text-red-800'     : f.estado_autorizacion==='rechazada',
                        'bg-gray-100 text-gray-700'   : !f.estado_autorizacion || f.estado_autorizacion==='ninguna'
                    }">
                        {{ f.estado_autorizacion || 'no requerida' }}
                    </span>
                </div>

                <!-- Datos básicos -->
                <div class="grid grid-cols-4 gap-x-4 gap-y-2 text-sm mb-2">
                    <div class="text-gray-500 dark:text-gray-400">Número DTE:</div>
                    <div class="font-medium text-gray-800 dark:text-gray-200 col-span-3">
                        <span class="bg-blue-50 dark:bg-blue-900 px-2 py-0.5 rounded text-blue-800 dark:text-blue-100">
                            {{ f.numero_dte }}
                        </span>
                    </div>

                    <div class="text-gray-500 dark:text-gray-400">Fecha Emisión:</div>
                    <div class="font-medium text-gray-800 dark:text-gray-200 col-span-1">{{ f.fecha_emision }}</div>

                    <div class="text-gray-500 dark:text-gray-400">Tipo DTE:</div>
                    <div class="font-medium text-gray-800 dark:text-gray-200 col-span-1">{{ f.tipo_dte }}</div>

                    <div class="text-gray-500 dark:text-gray-400">Autorización:</div>
                    <div class="font-medium text-gray-800 dark:text-gray-200 col-span-3">{{ f.numero_autorizacion }}
                    </div>

                    <div class="text-gray-500 dark:text-gray-400">Emisor:</div>
                    <div class="font-medium text-gray-800 dark:text-gray-200 col-span-3">{{ f.nombre_emisor }}</div>

                    <div class="text-gray-500 dark:text-gray-400">Monto Factura:</div>
                    <div class="font-semibold text-gray-900 dark:text-gray-100 col-span-1">
                        {{ (f.moneda==='USD' ? '$' : 'Q') }}{{ monto(f.monto_total) | number:'1.2-2' }}
                    </div>

                    <div class="text-gray-500 dark:text-gray-400">Monto Declarado:</div>
                    <div class="font-semibold text-gray-900 dark:text-gray-100 col-span-1">
                        {{ (f.moneda==='USD' ? '$' : 'Q') }}{{ monto(f.monto_liquidado) | number:'1.2-2' }}
                    </div>
                </div>

                <!-- Panel de información de vencimiento y autorización -->
                <div class="mb-3 border rounded p-3" [ngClass]="getClaseVencimiento()">
                    <div class="text-sm font-semibold mb-2">
                        Estado de Vencimiento
                    </div>

                    <!-- Información de validación de días hábiles -->
                    <div class="text-xs text-gray-600 dark:text-gray-300 space-y-1 mb-2">
                        <div class="p-2 rounded bg-white/50">
                            {{ getMensajeVencimiento() }}
                        </div>
                        <div *ngIf="validacionVencimiento && !cargandoValidacion">
                            <b>Días transcurridos:</b> {{ validacionVencimiento.diasTranscurridos }}
                        </div>
                        <div *ngIf="validacionVencimiento?.fechaInicioCalculo">
                            <b>Cálculo desde:</b> {{ validacionVencimiento?.fechaInicioCalculo | date:'shortDate' }}
                        </div>
                    </div>

                    <!-- Información de autorización si existe -->
                    <div *ngIf="f.estado_autorizacion && f.estado_autorizacion !== 'ninguna'"
                        class="text-xs text-gray-600 dark:text-gray-300 space-y-1 border-t pt-2">
                        <div class="font-semibold">Información de Autorización:</div>
                        <div><b>Estado:</b> {{ f.estado_autorizacion }}</div>
                        <div *ngIf="f.motivo_autorizacion"><b>Motivo:</b> {{ f.motivo_autorizacion }}</div>
                        <div *ngIf="f.fecha_solicitud"><b>Fecha solicitud:</b> {{ f.fecha_solicitud | date:'short' }}
                        </div>
                        <div *ngIf="f.fecha_autorizacion"><b>Fecha autorización:</b> {{ f.fecha_autorizacion |
                            date:'short' }}</div>
                        <div *ngIf="f.comentarios_autorizacion"><b>Comentarios:</b> {{ f.comentarios_autorizacion }}
                        </div>
                    </div>

                    <!-- Botón para solicitar autorización si es necesario -->
                    <div class="mt-2 flex gap-2" *ngIf="requiereAutorizacion(f)">
                        <button class="text-xs py-1.5 px-3 bg-orange-600 text-white rounded-md hover:bg-orange-700"
                            (click)="abrirAutorizacion()">
                            Solicitar autorización especial
                        </button>
                    </div>
                </div>

            </div>
        </ng-container>
    </div>

    <!-- Modales - Fuera del contenedor principal para que funcionen independientemente -->
    <app-modal-registrar-factura *ngIf="mostrarRegistrar" (cerrar)="cerrarRegistrar()"
        (facturaGuardada)="onFacturaGuardada()">
    </app-modal-registrar-factura>

    <app-modal-solicitar-autorizacion *ngIf="mostrarAutorizacion && (factura$ | async) as f" [numeroDte]="f.numero_dte"
        [fechaEmision]="f.fecha_emision" [diasTranscurridos]="validacionVencimiento?.diasTranscurridos || 0"
        (cerrar)="cerrarAutorizacion()" (solicitudEnviada)="onSolicitudEnviada()">
    </app-modal-solicitar-autorizacion>

    <!-- Debug temporal - eliminar después de verificar que funciona -->
    <div class="fixed top-4 right-4 bg-black text-white p-2 rounded text-xs z-50" *ngIf="false">
        Debug: mostrarRegistrar = {{ mostrarRegistrar }}
    </div>
</div>