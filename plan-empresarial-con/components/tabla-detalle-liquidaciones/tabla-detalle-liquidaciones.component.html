<!-- ============================================================================ -->
<!-- TEMPLATE TABLA DETALLE LIQUIDACIONES - CORREGIDO -->
<!-- ============================================================================ -->

<div class="bg-white dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 overflow-hidden">

    <!-- Header de la tabla -->
    <div class="px-3 py-2 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
        <div class="text-sm font-medium text-gray-900 dark:text-gray-100">Detalle de Liquidación</div>
        <div class="space-x-2 flex">
            <button
                class="px-3 py-1.5 text-sm rounded-md bg-blue-600 text-white hover:bg-blue-700 disabled:opacity-50 flex items-center gap-1"
                (click)="onAgregar()" [disabled]="!puedeEditarDetalles()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14" />
                    <path d="M12 5v14" />
                </svg>
                Agregar
            </button>
            <button
                class="px-3 py-1.5 text-sm rounded-md bg-green-600 text-white hover:bg-green-700 disabled:opacity-50 flex items-center gap-1"
                (click)="onGuardarTodo()" [disabled]="!puedeEditarDetalles() || detallesLiquidacion().length === 0">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="m19 21-7-4-7 4V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v16z" />
                </svg>
                Guardar Todo
            </button>
        </div>
    </div>

    <!-- Tabla -->
    <div class="relative overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-50 dark:bg-gray-700 sticky top-0 z-10">
                <tr class="text-left">
                    <th class="px-3 py-2 text-gray-700 dark:text-gray-200">Orden</th>
                    <th class="px-3 py-2 text-gray-700 dark:text-gray-200">Agencia</th>
                    <th class="px-3 py-2 text-gray-700 dark:text-gray-200">Descripción</th>
                    <th class="px-3 py-2 text-right text-gray-700 dark:text-gray-200">Monto</th>
                    <th class="px-3 py-2 text-gray-700 dark:text-gray-200">Forma pago</th>
                    <th class="px-3 py-2 text-center text-gray-700 dark:text-gray-200">Acciones</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                <tr *ngFor="let detalle of detallesLiquidacion(); let i = index; trackBy: trackById"
                    class="hover:bg-gray-50 dark:hover:bg-gray-700/40">

                    <!-- Número de orden -->
                    <td class="px-3 py-2 font-medium text-gray-900 dark:text-gray-100">{{ detalle?.numero_orden }}</td>

                    <!-- Agencia con edición inline -->
                    <td class="px-3 py-2">
                        <ng-container *ngIf="detalle._editandoAgencia; else mostrarAgencia">
                            <select #agenciaInput [(ngModel)]="detalle._agenciaTemp" (blur)="guardarAgencia(i)"
                                (keydown.enter)="guardarAgencia(i)" (keydown.escape)="cancelarEdicionAgencia(i)"
                                class="w-full border rounded px-2 py-1 text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                                <option value="" disabled>Seleccione una agencia</option>
                                <option *ngFor="let agencia of agenciasDisponibles(); trackBy: trackByAgencia"
                                    [value]="agencia.nombre_liquidacion">
                                    {{ agencia.nombre_liquidacion }}
                                </option>
                            </select>
                        </ng-container>
                        <ng-template #mostrarAgencia>
                            <span
                                class="cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 text-gray-900 dark:text-gray-100"
                                (click)="iniciarEdicionAgencia(i)">
                                {{ detalle.agencia || 'Sin especificar' }}
                            </span>
                        </ng-template>
                    </td>

                    <!-- Descripción -->
                    <td class="px-3 py-2">
                        <div class="max-w-xs truncate text-gray-900 dark:text-gray-100" [title]="detalle?.descripcion">
                            {{ detalle?.descripcion }}
                        </div>
                    </td>

                    <!-- Monto con edición inline -->
                    <td class="px-3 py-2">
                        <ng-container *ngIf="detalle._editandoMonto; else mostrarMonto">
                            <input #montoInput type="number" [(ngModel)]="detalle._montoTemp" (blur)="guardarMonto(i)"
                                (keydown.enter)="guardarMonto(i)" (keydown.escape)="cancelarEdicionMonto(i)"
                                class="w-full border rounded px-2 py-1 text-right text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white"
                                min="0" step="0.01" />
                        </ng-container>
                        <ng-template #mostrarMonto>
                            <span
                                class="cursor-pointer hover:text-blue-600 dark:hover:text-blue-400 text-right block text-gray-900 dark:text-gray-100"
                                (click)="iniciarEdicionMonto(i)">
                                Q{{ (detalle.monto || 0) | number:'1.2-2' }}
                            </span>
                        </ng-template>
                    </td>

                    <!-- Forma de pago -->
                    <td class="px-3 py-2">
                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                            [ngClass]="obtenerClaseFormaPago(detalle?.forma_pago || '')">
                            {{ obtenerTextoFormaPago(detalle?.forma_pago || '') }}
                        </span>
                    </td>

                    <!-- Acciones -->
                    <td class="px-3 py-2">
                        <div class="flex items-center justify-center gap-1">
                            <button
                                class="p-1.5 rounded hover:bg-blue-50 dark:hover:bg-blue-900/30 text-blue-600 dark:text-blue-400"
                                (click)="verDetalleCompleto(i)" title="Ver detalle completo">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z" />
                                    <circle cx="12" cy="12" r="3" />
                                </svg>
                            </button>
                            <button
                                class="p-1.5 rounded hover:bg-amber-50 dark:hover:bg-amber-900/30 text-amber-600 dark:text-amber-400"
                                (click)="onEditar(i)" [disabled]="!puedeEditarDetalles()" title="Editar completo">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z" />
                                    <path d="m15 5 4 4" />
                                </svg>
                            </button>
                            <button
                                class="p-1.5 rounded hover:bg-sky-50 dark:hover:bg-sky-900/30 text-sky-600 dark:text-sky-400"
                                (click)="onCopiar(i)" [disabled]="!puedeEditarDetalles()" title="Copiar">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect width="14" height="14" x="8" y="8" rx="2" ry="2" />
                                    <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2" />
                                </svg>
                            </button>
                            <button
                                class="p-1.5 rounded hover:bg-red-50 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400"
                                (click)="onEliminar(i)" [disabled]="!puedeEditarDetalles()" title="Eliminar">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M3 6h18" />
                                    <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                                    <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
                                    <line x1="10" x2="10" y1="11" y2="17" />
                                    <line x1="14" x2="14" y1="11" y2="17" />
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>

                <!-- Fila vacía -->
                <tr *ngIf="detallesLiquidacion().length === 0">
                    <td colspan="6" class="px-6 py-10 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex flex-col items-center gap-2">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400">
                                <circle cx="12" cy="12" r="10" />
                                <path d="M12 16v-4" />
                                <path d="M12 8h.01" />
                            </svg>
                            <p class="text-sm">Sin registros de liquidación.</p>
                            <p class="text-xs text-gray-400">Usa "Agregar" para crear uno nuevo.</p>
                        </div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Indicador de guardando cambios -->
    <div *ngIf="guardandoCambios()" class="absolute inset-0 bg-black/10 flex items-center justify-center">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-3 shadow-lg flex items-center gap-2">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round" class="animate-spin">
                <path d="M21 12a9 9 0 1 1-6.219-8.56" />
            </svg>
            <span class="text-sm text-gray-700 dark:text-gray-200">Guardando cambios...</span>
        </div>
    </div>

</div>

<!-- Modales -->
<app-modal-detalle-liquidacion *ngIf="mostrarModalDetalle()" [visible]="mostrarModalDetalle()" [modo]="modoModal()"
    [registro]="registroEnEdicion" (visibleChange)="mostrarModalDetalle.set($event)">
</app-modal-detalle-liquidacion>

<app-modal-confirmar-eliminacion *ngIf="mostrarModalEliminar()" [titulo]="'Confirmar eliminación'"
    [mensaje]="'¿Está seguro(a) de eliminar este detalle? Esta acción no se puede deshacer.'"
    (confirmar)="confirmarEliminacion()" (cancelar)="cancelarEliminacion()">
</app-modal-confirmar-eliminacion>