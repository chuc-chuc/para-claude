<div class="w-full h-80 flex flex-col">
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 h-full flex flex-col">

        <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
            <h2 class="text-sm font-medium text-gray-900">
                Gestión de <span
                    class="text-transparent bg-clip-text bg-gradient-to-r to-blue-600 from-indigo-400">Facturas</span>
            </h2>
            <button (click)="abrirModalRegistrar()"
                class="text-gray-400 hover:text-gray-500 p-1 rounded-full transition-colors"
                title="Registrar nueva factura">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>

        <div class="px-2 py-1 border-b border-gray-100">
            <div class="flex gap-2">
                <input [formControl]="searchControl" type="search"
                    class="pl-3 pr-3 py-2 block w-full text-sm text-gray-900 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500"
                    placeholder="Ingrese número DTE y presione Enter o espere (mín. 3 caracteres)" />

                <button (click)="buscarManual()"
                    class="px-3 py-2 text-xs bg-blue-600 text-white rounded-md hover:bg-blue-700">
                    Buscar
                </button>

                <ng-container *ngIf="facturaActual() as factura">
                    <button *ngIf="factura.estado_factura !== 'Anulado' && requiereAutorizacion(factura)"
                        class="px-3 py-2 text-xs bg-orange-600 text-white rounded-md hover:bg-orange-700"
                        (click)="abrirModalAutorizacion()">
                        Solicitar autorización
                    </button>
                </ng-container>
            </div>
        </div>

        <div *ngIf="cargandoFactura()" class="flex-1 grid place-items-center p-6">
            <div class="flex items-center space-x-2 text-gray-500">
                <div class="w-6 h-6 border-2 border-gray-300 border-t-blue-600 rounded-full animate-spin"></div>
                <span class="text-sm">Cargando...</span>
            </div>
        </div>

        <div *ngIf="!cargandoFactura() && !facturaActual()"
            class="flex-1 grid place-items-center p-6 text-sm text-gray-500">
            <span>Busque una factura para ver su detalle</span>
        </div>

        <ng-container *ngIf="!cargandoFactura() && facturaActual() as factura">
            <div class="px-2 py-1 overflow-auto">

                <div class="flex flex-wrap gap-1 mb-1">
                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold"
                        [ngClass]="obtenerColorEstadoLiquidacion(factura.estado_liquidacion)">
                        Estado Liquidacíon: {{ factura.estado_liquidacion }}
                    </span>

                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold"
                        [ngClass]="obtenerColorEstadoFactura(factura.estado_factura || 'vigente')">
                        Estado Factura: {{ factura.estado_factura || 'vigente' }}
                    </span>

                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold"
                        [ngClass]="obtenerInfoVencimiento().clase">
                        {{ obtenerInfoVencimiento().mensaje }}
                    </span>

                    <span class="px-2.5 py-1 rounded-full text-xs font-semibold capitalize"
                        [ngClass]="obtenerColorEstadoAutorizacion(factura.estado_autorizacion || 'ninguna')">
                        {{ factura.estado_autorizacion || 'no requerida' }}
                    </span>
                </div>

                <div class="grid grid-cols-4 gap-x-4 gap-y-2 text-sm mb-2">
                    <div class="text-gray-500">Número DTE:</div>
                    <div class="font-medium text-gray-800 col-span-3">
                        <span class="bg-blue-50 px-2 py-0.5 rounded text-blue-800">
                            {{ factura.numero_dte }}
                        </span>
                    </div>

                    <div class="text-gray-500">Fecha Emisión:</div>
                    <div class="font-medium text-gray-800 col-span-1">{{ formatearFecha(factura.fecha_emision) }}</div>

                    <div class="text-gray-500">Tipo DTE:</div>
                    <div class="font-medium text-gray-800 col-span-1">{{ factura.tipo_dte }}</div>

                    <div class="text-gray-500">Autorización:</div>
                    <div class="font-medium text-gray-800 col-span-3">{{ factura.numero_autorizacion }}</div>

                    <div class="text-gray-500">Emisor:</div>
                    <div class="font-medium text-gray-800 col-span-3">{{ factura.nombre_emisor }}</div>

                    <div class="text-gray-500">Monto Factura:</div>
                    <div class="font-semibold text-gray-900 col-span-1">
                        {{ formatearMonto(factura.monto_total) }}
                    </div>

                    <div class="text-gray-500">Monto Liquidado:</div>
                    <div class="font-semibold text-gray-900 col-span-1">
                        {{ formatearMonto(calcularTotalDetalles()) }}
                    </div>

                    <div class="text-gray-500">Monto Retención:</div>
                    <div class="font-semibold col-span-1"
                        [ngClass]="obtenerMontoRetencion() > 0 ? 'text-orange-700' : 'text-gray-500'">
                        {{ formatearMonto(obtenerMontoRetencion()) }}
                    </div>

                    <ng-container *ngIf="factura.cantidad_liquidaciones && factura.cantidad_liquidaciones > 0">
                        <div class="text-gray-500">Liquidaciones:</div>
                        <div class="font-medium text-gray-800 col-span-1">
                            {{ factura.cantidad_liquidaciones }} registradas
                        </div>
                    </ng-container>
                </div>

                <div class="mb-3 border rounded p-3" [ngClass]="obtenerInfoVencimiento().clase">
                    <div class="text-sm font-semibold mb-2">Estado General</div>

                    <div class="text-xs text-gray-600 space-y-1 mb-2">
                        <div class="p-2 rounded bg-white/50">
                            {{ obtenerMensajeEstado() }}
                        </div>

                        <ng-container *ngIf="obtenerEstadisticasFactura() as stats">
                            <div><b>Total detalles:</b> {{ formatearMonto(stats.totalLiquidado || 0) }}</div>
                            <div><b>Pendiente:</b> {{ formatearMonto(stats.montoPendiente || 0) }}</div>
                            <div><b>Progreso:</b> {{ (stats.porcentajeLiquidado || 0) | number:'1.1-1' }}%</div>
                        </ng-container>

                        <div *ngIf="validacionDiasHabiles() as validacion">
                            <b>Días transcurridos:</b> {{ validacion.diasTranscurridos }}
                        </div>

                        <div *ngIf="hayDiferenciaMontos()" class="text-red-600">
                            <b>⚠️ Hay diferencias en los montos</b>
                        </div>
                    </div>

                    <div *ngIf="factura.estado_autorizacion && factura.estado_autorizacion !== 'ninguna'"
                        class="text-xs text-gray-600 space-y-1 border-t pt-2">
                        <div class="font-semibold">Información de Autorización:</div>
                        <div><b>Estado:</b> {{ factura.estado_autorizacion }}</div>
                        <div *ngIf="factura.motivo_autorizacion"><b>Motivo:</b> {{ factura.motivo_autorizacion }}</div>
                        <div *ngIf="factura.fecha_solicitud"><b>Fecha solicitud:</b> {{
                            formatearFecha(factura.fecha_solicitud) }}</div>
                        <div *ngIf="factura.fecha_autorizacion"><b>Fecha autorización:</b> {{
                            formatearFecha(factura.fecha_autorizacion) }}</div>
                        <div *ngIf="factura.comentarios_autorizacion"><b>Comentarios:</b> {{
                            factura.comentarios_autorizacion }}</div>
                        <div *ngIf="factura.autorizado_por"><b>Autorizado por:</b> {{ factura.autorizado_por }}</div>
                    </div>
                </div>

                <ng-container *ngIf="obtenerEstadisticasFactura() as stats">
                    <div class="mb-3">
                        <div class="flex justify-between text-xs text-gray-600 mb-1">
                            <span>Progreso de liquidación</span>
                            <span>{{ (stats.porcentajeLiquidado || 0) | number:'1.1-1' }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div class="h-2 rounded-full transition-all duration-300"
                                [style.width.%]="stats.porcentajeLiquidado || 0"
                                [ngClass]="(stats.porcentajeLiquidado || 0) >= 100 ? 'bg-green-600' : (stats.porcentajeLiquidado || 0) > 100 ? 'bg-red-600' : 'bg-blue-600'">
                            </div>
                        </div>
                    </div>
                </ng-container>
            </div>
        </ng-container>

    </div>

    <app-modal-registrar-factura *ngIf="mostrarModalRegistrar()" (cerrar)="cerrarModalRegistrar()"
        (facturaRegistrada)="onFacturaRegistrada()">
    </app-modal-registrar-factura>

    <app-modal-solicitar-autorizacion *ngIf="mostrarModalAutorizacion() && facturaActual() as factura"
        [numeroDte]="factura.numero_dte" [fechaEmision]="factura.fecha_emision"
        [diasTranscurridos]="validacionDiasHabiles()?.diasTranscurridos || 0" (cerrar)="cerrarModalAutorizacion()"
        (solicitudEnviada)="onSolicitudEnviada()">
    </app-modal-solicitar-autorizacion>

</div>